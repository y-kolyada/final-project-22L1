# -*- mode: ruby -*-
# vi: set ft=ruby :

SSH_PORT_SUFFIX = 50
$GW_IP = "10.0.10.1"
$HOST_IP = "10.0.10.2"
$DEV001_IP = "10.0.10.60"
$DEV_IP = "10.0.10.50"

=begin
  Vagrant script to build DEV, QA, INTEG and PROD environment
=end

set_server_multi_user_target = <<-SHELL
  dnf groupinstall -y "Server"
  dnf groupremove -y "Workstation"
  dnf groupremove -y "Server with GIU"
  systemctl set-default multi-user.target
  systemctl get-default 
  dnf -y update
SHELL

set_server_gui_multi_user_target = <<-SHELL
  dnf groupinstall -y "Server with GIU"
  dnf groupremove -y "Workstation"
  dnf groupremove -y "Server"
  systemctl set-default graphical.target
  systemctl get-default 
  dnf -y update
SHELL

set_workstation_graphical_target = <<-SHELL
  dnf groupinstall -y "Workstation"
  dnf groupremove -y "Server"
  dnf groupremove -y "Server with GIU"
  systemctl set-default graphical.target
  systemctl get-default 
  dnf -y update
SHELL

get_current_default_kernel = <<-SHELL
  #grubby --set-default /boot/vmlinuz-4.18.0-408.el8.x86_64  
  rpm -q kernel
  ls /boot/vm*
  grubby --default-kernel  
SHELL

remove_old_kernels = <<-SHELL
  dnf -y remove --oldinstallonly --setopt installonly_limit=2 kernel
SHELL

update_kernel = <<-SHELL
  dnf update -y kernel-*  
SHELL

update_system = <<-SHELL
  dnf update -y  
SHELL


change_default_route = <<-SHELL
  echo "GW_IP: ${GW_IP}"
  RM_ROUTE=$(ip route | grep "default via 10.0.2.2 dev eth0")
  if [[ $RM_ROUTE == *"default via 10.0.2.2 dev eth0"* ]]; then
    ip route del default via 10.0.2.2 dev eth0
  fi
  RM_ROUTE=$(ip route | grep "default via 10.0.10.1 dev eth1")
  if [[ -z $RM_ROUTE ]]; then
    ip route add default via ${GW_IP} dev eth1
  fi
SHELL

install_virtualbox_guets_additions = <<-SHELL
  #dnf install -y gcc make perl kernel-devel kernel-headers bzip2 dkms
  dnf install -y epel-release
  dnf install -y gcc make perl kernel-devel kernel-headers bzip2 dkms
  rpm -q kernel
  wget -q https://download.virtualbox.org/virtualbox/7.0.4/VBoxGuestAdditions_7.0.4.iso -P /tmp
  mkdir -p /mnt/GA
  mount /tmp/VBoxGuestAdditions_7.0.4.iso /mnt/GA
  cd /mnt/GA
  sh ./VBoxLinuxAdditions.run install
  #systemctl disable vboxadd-service
  #systemctl disable vboxadd
  #systemctl stop vboxadd-service
  #systemctl stop vboxadd
SHELL

Vagrant.configure("2") do |config|
  # https://docs.vagrantup.com.
  # https://vagrantcloud.com/search.
  config.vm.box = "centos/stream8"
  config.vm.box_version = "20210210.0"
  
  ### CORP Environment: Developers workstations
  config.vm.define "dev001" do |dev001|
    dev001.vm.host_name = "dev001"
    dev001.vm.provider "virtualbox" do |v|
      v.gui = true
      v.name = "dev001"
      v.memory = 3072
      v.cpus = 2
      v.check_guest_additions = false
      v.customize ["modifyvm", :id, "--graphicscontroller", "VMSVGA"] 
      v.customize ["modifyvm", :id, "--vram", "128"] 
    end

    #config.vm.network "public_network", auto_config: false
    dev001.vm.network :forwarded_port, guest: 22, host: "222#{SSH_PORT_SUFFIX+10}", 
      host_ip: "127.0.0.1", id: "ssh"
    dev001.vm.network "public_network", bridge: 'enp8s0', ip: $DEV001_IP

    dev001.vm.provision "change_default_route", type: "shell", run: "always", 
      env: {"GW_IP" => $GW_IP}, inline: change_default_route

    dev001.vm.provision "set_workstation_graphical_target", type: "shell", run: "once", 
      inline: set_workstation_graphical_target

    dev001.vm.provision "get_current_default_kernel", type: "shell", run: "always", 
      inline: get_current_default_kernel

    dev001.vm.provision "install_virtualbox_guets_additions", type: "shell", run: "never", 
      inline: install_virtualbox_guets_additions
  end  

  ### DEV Environment
  config.vm.define "dev" do |dev|
    dev.vm.host_name = "dev"
    dev.vm.provider "virtualbox" do |v|
      v.gui = true
      v.name = "dev"
      v.memory = 3072
      v.cpus = 2
      v.check_guest_additions = false
      v.customize ["modifyvm", :id, "--graphicscontroller", "VMSVGA"] 
      v.customize ["modifyvm", :id, "--vram", "128"] 
    end

    #config.vm.network "public_network", auto_config: false
    dev.vm.network :forwarded_port, guest: 22, host: "222#{SSH_PORT_SUFFIX}", id: "ssh"
    dev.vm.network "public_network", bridge: 'enp8s0', ip: $DEV_IP
  	
    dev.vm.provision "change_default_route", type: "shell", run: "always", 
      env: {"GW_IP" => $GW_IP}, inline: change_default_route

    dev.vm.provision "set_server_multi_user_target", type: "shell", run: "once", 
      inline: set_server_multi_user_target

    dev.vm.provision "get_current_default_kernel", type: "shell", run: "always", 
      inline: get_current_default_kernel

    dev.vm.provision "install_virtualbox_guets_additions", type: "shell", run: "never", 
      inline: install_virtualbox_guets_additions
  end

  if Vagrant.has_plugin?("vagrant-vbguest")
    config.vbguest.auto_update = true
  end

  config.vm.provision "update_kernel", type: "shell", run: "once", 
    inline: update_kernel
 
  config.vm.provision "remove_old_kernels", type: "shell", run: "never", 
    inline: remove_old_kernels
  
  config.vm.provision "update_system", type: "shell", run: "always", 
    inline: update_system

end
